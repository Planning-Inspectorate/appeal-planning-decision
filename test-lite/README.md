# Cypress E2E tests

### Overview

The [Cypress](https://docs.cypress.io/guides/overview/why-cypress.html#In-a-nutshell) framework provides support 
for automated testing and BDD. 

#### Running against a different base URL

By default, Cypress will run tests against the URL defines in the `baseUrl` setting in `cypress.json` (currently,
[localhost:9003](http://localhost:9003)). If you wish to switch to a different URL, you can set an environment
variable to do so. For example, to run against the prod cluster.

```shell
CYPRESS_BASE_URL=http://appeal-planning-decision.planninginspectorate.gov.uk npm run test:e2e
```

If you wish to test against a different cluster secured with HTTP Basic authentication, you add this into the
environment variable. For instance, if the username was `hello` and the password `world`:

```shell
CYPRESS_BASE_URL=http://hello:world@appeals-dev.planninginspectorate.gov.uk npm run test:e2e
```

> This is not the password. For (obvious) security purposes, this is never checked into this repo.

If you wish to run this inside GitHub Actions against an environment, a secret is configured with all URLs (and
any authentication):
 - `CYPRESS_DEV_BASE_URL`
 - `CYPRESS_PREPROD_BASE_URL`
 - `CYPRESS_PROD_BASE_URL`

#### Video artefacts

Each test run can generate a video record of the tests and the browser behaviour. In addition to their use in 
ci pipelines and local development, these recordings have potential to serve as evidence of delivery of required 
behaviour e.g. played at demo events. Typically, the tests should complete as quickly as possible and this should be 
the default. However, when producing video artefacts intended to be presented it may be convenient to manage periods 
of waiting or pausing during the test execution. Environment variables can be used for this configuration and one 
named `demoDelay` is provided in the `cypress.json` file. The variable can be used in statements 
like `cy.wait(Cypress.env('demoDelay'))` to control wait times i.e. the value is the required delay in milliseconds.
From the `e2e-tests` folder, the tests can be run locally setting the delay period with commands like this for 
selection of tests by tags i.e. only those with `@wip` tag:
```
node_modules/cypress/bin/cypress run --headed -b chrome --env demoDelay=1000 -e TAGS="@wip"
```
or like this to select a specific feature file:
```
node_modules/cypress/bin/cypress run --headed -b chrome --env demoDelay=1000 --spec cypress/integration/appeal-statement-submission.feature
```

Evidence for FQC can be generated by running the tests or a subset of them against any accessible environment e.g.
```
node_modules/cypress/bin/cypress run --headed -b chrome --config baseUrl="https://appeals-dev.planninginspectorate.gov.uk/" --spec "cypress/integration/appellant-submission-your-details-*.feature" --env TAGS='not @wip',demoDelay=1000
```


#### Test data

The maximum permitted file size for uploading is configurable with a default value of 50MB. 
A script `create-large-test-files.sh` is available to create files to support testing and should be run automatically 
using `make install`. This will look for an env var `FILE_UPLOAD_MAX_FILE_SIZE_BYTES` and will use the value there if present instead of the default.
The files named `appeal-statement-invalid-too-big.png` and `appeal-statement-valid-max-size.png` will be placed in 
the `cypress/fixtures` folder. This script runs as part of the CI sequence to ensure that the files are available 
for e2e tests in the pipelines. To create the required files locally run this command once from the `e2e-tests` folder:
````
./create-large-test-files.sh
````
