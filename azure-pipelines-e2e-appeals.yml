parameters:
  - name: Environment
    type: string
    default: 'staging'
    values:
      - 'dev'
      - 'test'
      - 'staging'
  - name: SmokeOnly
    type: boolean
    default: true

variables:
  - name: APP
    value: 'appeals'
  - group: e2e
  - group: e2e-${{ parameters.Environment }}

# PR trigger disabled, until process has been agreed by team
pr: none
trigger: none

# pr:
#   branches:
#     include:
#       - main
#   paths:
#     include:
#       - test-packages/platform-feature-tests

schedules:
    - cron: '30 3 * * 2-6'
      displayName: Weekday test run
      branches:
          include:
              - main
      always: true

jobs:
  - job: Run_Cypress_Tests_For_Appeals
    timeoutInMinutes: 120
    pool: pins-odt-agent-pool-tests

    strategy:
   #   maxParallel: 1  # run matrix groups sequentially
      matrix:
        group1:
          GROUP_NAME: 'E2E-S78'
          SPEC: cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-refused.cy.js
          #,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-questionnaire-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-questionnaire.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-statement-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-statement.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-final-comment-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-final-comment.cy.js,cypress/e2e/appellant-aapd/full-appeal-appellant-final-comment-validation.cy.js,cypress/e2e/appellant-aapd/full-appeal-appellant-final-comment.cy.js,cypress/e2e/appellant-aapd/appeallant-decided-appeals.cy.js,cypress/e2e/lpa-manage-appeals/lpa-decided-appeals.cy.js
        group2:
          GROUP_NAME: 'E2E-HAS'
          SPEC: cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-refused.cy.js
          #,cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-validation.cy.js,cypress/e2e/lpa-manage-appeals/house-holder-questionnaire-validation.cy.js,cypress/e2e/lpa-manage-appeals/house-holder-questionnaire.cy.js
        group3:
          GROUP_NAME: 'E2E-S20'
          SPEC: cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-granted.cy.js,cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-refused.cy.js
          #,cypress/e2e/lpa-manage-appeals/listed-building-questionnaire.cy.js,cypress/e2e/lpa-manage-appeals/listed-building-statement.cy.js,cypress/e2e/lpa-manage-appeals/listed-building-final-comment.cy.js
        group4:
          GROUP_NAME: 'E2E-CAS-PLANNING'
          SPEC: cypress/e2e/appellant-aapd/submit-casplanning-appeal/submit-casplanning-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-casplanning-appeal/submit-casplanning-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-casplanning-appeal/submit-casplanning-appeal-refused.cy.js
          #,cypress/e2e/lpa-manage-appeals/cas-planning-questionnaire.cy.js
        group5:
          GROUP_NAME: 'E2E-CAS-ADVERT'
          SPEC: cypress/e2e/appellant-aapd/submit-casadvert-appeal/submit-casadvert-appeal-refused.cy.js
          #,cypress/e2e/lpa-manage-appeals/cas-advert-questionnaire.cy.js
        group6:
          GROUP_NAME: 'E2E-ADVERT'
          SPEC: cypress/e2e/appellant-aapd/submit-advert-appeal/submit-advert-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-advert-appeal/submit-advert-appeal-nodecision.cy.js
          #,cypress/e2e/lpa-manage-appeals/advert-questionnaire.cy.js
        group7:
          GROUP_NAME: 'E2E-LDC'
          SPEC: cypress/e2e/appellant-aapd/submit-ldc-appeal/submit-ldc-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-ldc-appeal/submit-ldc-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-ldc-appeal/submit-ldc-appeal-refused.cy.js,cypress/e2e/appellant-aapd/submit-ldc-appeal/submit-ldc-appeal-noListedBuilding.cy.js       

    steps:
      - checkout: self
        fetchDepth: 1
        fetchTags: false

      # - script: |
      #     set -euo pipefail
      #     rm -rf test-packages/platform-feature-tests/cypress/reports/reports/.jsons || true
      #     mkdir -p test-packages/platform-feature-tests/cypress/reports/reports
      #   displayName: 'Clean Cypress reports (.jsons)'
      #   condition: always()

      - task: NodeTool@0
        inputs:
          versionSpec: '22.x'
        displayName: 'Install Node.js'

      - task: Npm@1
        inputs:
          command: 'install'
          workingDir: $(System.DefaultWorkingDirectory)/test-packages/platform-feature-tests
        displayName: 'Install Dependencies'

      - task: ShellScript@2
        inputs:
          scriptPath: 'test-packages/platform-feature-tests/install-chromium.sh'
        displayName: 'Install Chromium'
        condition: and(succeeded(), eq(variables['agent.os'], 'Linux'))

      - script: |
          set -euo pipefail
          cd test-packages/platform-feature-tests
          echo "Running specs for group $(GROUP_NAME): $(SPEC)"
          SMOKE_ONLY_NORMALIZED=$(echo "${SMOKE_ONLY:-}" | tr '[:upper:]' '[:lower:]')
          if [ "$SMOKE_ONLY_NORMALIZED" = "true" ]; then
            echo "SmokeOnly enabled: running @smoke tagged tests only"
            TAG_ARGS="--env grepTags=smoke,grepFilterSpecs=true,grepOmitFiltered=true"
          else
            TAG_ARGS=""
          fi
          npx cypress run --spec "$(SPEC)" $TAG_ARGS
        env:
          CYPRESS_APPEALS_BETA_BASE_URL: $(CYPRESS_APPEALS_BETA_BASE_URL)
          CYPRESS_BACK_OFFICE_BASE_URL: $(CYPRESS_BACK_OFFICE_BASE_URL)
          AUTH_EMAIL: $(AUTH_EMAIL)
          AUTH_PASSWORD: $(AUTH_PASSWORD)
          CASE_ADMIN_EMAIL: $(CASE_ADMIN_EMAIL)
          GROUP_NAME: $(GROUP_NAME)
          SPEC: $(SPEC)
          SMOKE_ONLY: ${{ parameters.SmokeOnly }}
        displayName: 'Run Cypress Tests'

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: 'test-packages/platform-feature-tests/cypress/reports'
          artifactName: 'FailedTests-$(GROUP_NAME)'
        displayName: 'Publish Failed Tests Artifacts'
        condition: failed()