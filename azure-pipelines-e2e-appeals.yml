parameters:
  - name: Environment
    type: string
    default: 'dev'
    values: ['dev', 'test']

  - name: RunParallel
    type: boolean
    default: false   # default = single agent for scheduled runs

variables:
  - name: APP
    value: 'appeals'
  - group: e2e-${{ parameters.Environment }}

pr: none
trigger: none

schedules:
  - cron: "0 2 * * 1-5"
    displayName: Weekday test run
    branches:
      include: [main]
    always: true

jobs:
  - job: Run_Cypress_Tests_For_Appeals
    timeoutInMinutes: 90
    pool: pins-odt-agent-pool-tests

    strategy:
      # ðŸŸ¢ PARALLEL RUNS (manual toggle)
      ${{ if eq(parameters.RunParallel, true) }}:
        matrix:
          group1:
            SPEC: cypress/e2e/onboarded-lpa-check.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-granted.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-refused.cy.js,cypress/e2e/appellant-aapd/submit-full-appeal/submit-full-appeal-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-questionnaire-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-questionnaire.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-statement-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-statement.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-final-comment-validation.cy.js,cypress/e2e/lpa-manage-appeals/full-appeal-final-comment.cy.js,cypress/e2e/appellant-aapd/full-appeal-appellant-final-comment-validation.cy.js,cypress/e2e/appellant-aapd/full-appeal-appellant-final-comment.cy.js,cypress/e2e/appellant-aapd/appeallant-decided-appeals.cy.js,cypress/e2e/lpa-manage-appeals/lpa-decided-appeals.cy.js
          group2:
            SPEC: cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-refused.cy.js,cypress/e2e/appellant-aapd/submit-householder-appeal/submit-householder-appeal-validation.cy.js,cypress/e2e/lpa-manage-appeals/house-holder-questionnaire-validation.cy.js,cypress/e2e/lpa-manage-appeals/house-holder-questionnaire.cy.js
          group3:
            SPEC: cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-granted.cy.js,cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-nodecision.cy.js,cypress/e2e/appellant-aapd/submit-listed-building-appeal/submit-listed-building-refused.cy.js,cypress/e2e/lpa-manage-appeals/listed-building-questionnaire.cy.js,cypress/e2e/lpa-manage-appeals/listed-building-statement.cy.js,cypress/e2e/lpa-manage-appeals/listed-building-final-comment.cy.js,cypress/e2e/ip-comments/ip-comments.cy.js

      # ðŸŸ¡ SINGLE AGENT RUN (default)
      ${{ if eq(parameters.RunParallel, false) }}:
        matrix:
          single:
            SPEC: cypress/e2e/**/*.cy.js

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: "22.x"
        displayName: "Install Node.js"

      - task: ShellScript@2
        inputs:
          scriptPath: 'appeals/e2e/install-chromium.sh'
        displayName: 'Install Chromium'
        condition: eq(variables['agent.os'], 'Linux')

      - task: Npm@1
        inputs:
          command: "install"
          workingDir: $(System.DefaultWorkingDirectory)/appeals/e2e
        displayName: "Install Dependencies"

      - script: |
          echo "Running Cypress specs: $(SPEC)"
          npx cypress run --spec "$(SPEC)"
        workingDirectory: $(System.DefaultWorkingDirectory)/appeals/e2e
        env:
           CYPRESS_APPEALS_BETA_BASE_URL: $(CYPRESS_APPEALS_BETA_BASE_URL)
              CYPRESS_BACK_OFFICE_BASE_URL: $(CYPRESS_BACK_OFFICE_BASE_URL)
              AUTH_EMAIL: $(AUTH_EMAIL)
              AUTH_PASSWORD: $(AUTH_PASSWORD)
              CASE_ADMIN_EMAIL: $(CASE_ADMIN_EMAIL)
              SPEC: $(SPEC)
              SMOKE_ONLY: ${{ parameters.SmokeOnly }}
              OS_NAME: $(OS_NAME)
              CYPRESS_CACHE_FOLDER: $(CYPRESS_CACHE_FOLDER)
              PUPPETEER_CACHE_DIR: $(PUPPETEER_CACHE_DIR)
        displayName: "Run Cypress Tests"        

      - task: PublishBuildArtifacts@1
        condition: failed()
        inputs:
          pathToPublish: 'appeals/e2e/cypress/screenshots'
          artifactName: 'FailedTests'
        displayName: "Publish Failed Tests Artifacts"