# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- feature/as-3074-appeal-service-api-pipeline

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'
  dockerfilePath: '$(Build.SourcesDirectory)/packages/appeals-service-api/Dockerfile'
  azureSubscriptionEndpoint: PINS ACPHZN Prod (cbd9712b-34c8-4c94-9633-37ffc0f54f9d)
  imageName: appealServiceApiImage
  imageRepository: PINSPortalContainerRepository
  # dockerRegistryServiceConnection: xxxxxxxxxxxx

stages:
- stage: BuildAndPush
  displayName: BuildAndPush
  jobs:
  - job: BuildAndPush
    displayName: Build and Push image
    steps:
    - task: Docker@2
      displayName: Build
      inputs:
        command: build
        repository: $(imageName)
        dockerfile: $(dockerfilePath)
        tags: |
          appeal-service-api
    - task: Docker@2
      displayName: Push
      inputs:
        command: push
        repository: $(imageName)
        containerRegistry: $(imageRepository)
        tags: |
          appeal-service-api

# - stage: Deploy
#   displayName: Deploy WebApp
#   jobs:
#   - job: Deploy
#     displayName: Deploy
#     steps:
#     # - task: AzureWebApp@1
#     #   inputs:
#     #     appType: webApp
#     #     azureSubscription: 'PINS ACPHZN Prod'
#     #     appName: 'appeal-service-api'
#     #     package: '$(System.DefaultWorkingDirectory)'
#     #     customWebConfig: '-Handler iisnode -NodeStartFile server.js -appType node'
#     - task: AzureRMWebAppDeployment@4
#       displayName: Appeals Service API Deploy
#       inputs:
#         appType: webAppContainer
#         ConnectedServiceName: $(azureSubscriptionEndpoint)
#         WebAppName: $(WebAppName)
#         DockerNamespace: $(DockerNamespace)
#         DockerRepository: $(DockerRepository)
#         DockerImageTag: $(Build.BuildId)