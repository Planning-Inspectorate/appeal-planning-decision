# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- feature/as-3074-appeal-service-api-pipeline

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'
  dockerfilePath: '$(Build.SourcesDirectory)/packages/appeals-service-api/Dockerfile'
  azureSubscriptionEndpoint: PINS

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@2
      displayName: Build an image
      inputs:
        command: build
        dockerfile: $(dockerfilePath)
        tags: |
          $(tag)

- stage: Deploy
  displayName: Deploy WebApp
  jobs:
  - job: Deploy
    displayName: Deploy
    steps:
    # - task: AzureWebApp@1
    #   inputs:
    #     appType: webApp
    #     azureSubscription: 'PINS ACPHZN Prod'
    #     appName: 'appeal-service-api'
    #     package: '$(System.DefaultWorkingDirectory)'
    #     customWebConfig: '-Handler iisnode -NodeStartFile server.js -appType node'
    - task: AzureRMWebAppDeployment@4
      displayName: Appeals Service API Deploy
      inputs:
        appType: webAppContainer
        ConnectedServiceName: $(azureSubscriptionEndpoint)
        WebAppName: $(WebAppName)
        DockerNamespace: $(DockerNamespace)
        DockerRepository: $(DockerRepository)
        DockerImageTag: $(Build.BuildId)