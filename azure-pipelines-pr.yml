trigger:
  branches:
    include:
      # trigger for merge queue branches
      - gh-readonly-queue/*

pr:
  branches:
    include:
      - '*'

variables:
- name: test-script
  ${{ if startsWith(variables['Build.SourceBranch'], 'refs/heads/gh-readonly-queue') }}:
    value: npm run test
  ${{ else }}:
    value: npm run test-cov

jobs:
- job: LintAndTest
  timeoutInMinutes: 30
  workspace:
    clean: all
  steps:  
  - task: UseNode@1
    inputs:
      version: '22.x'
  - checkout: self
    clean: true
    persistCredentials: true
    fetchDepth: 1
    fetchTags: false
  - script: npm ci
    displayName: 'npm ci'
  - script: npm run lint
    displayName: 'npm run lint'
  - script: $(test-script):appeals-api
    displayName: 'test appeals-api'
  - script: $(test-script):auth-server
    displayName: 'test auth server'
  - script: $(test-script):business-rules
    displayName: 'test business-rules'
  - script: $(test-script):common
    displayName: 'test common'
  - script: $(test-script):documents-api
    displayName: 'test documents-api'
  - script: $(test-script):functions
    displayName: 'test functions'
  - script: $(test-script):pdf-api
    displayName: 'test pdf-api'
  - script: $(test-script):web
    displayName: 'test web'
  - task: PublishCodeCoverageResults@2
    condition: and(succeeded(), not(startsWith(variables['Build.SourceBranch'], 'refs/heads/gh-readonly-queue')))
    inputs:
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage/cobertura-coverage.xml'
    displayName: 'Publish Code Coverage Results'
