# Port ranges (by convention):
#  - API: 3000-3999
#  - Services: 4000-4999
#  - Mocks: 5000-5999
#  - Documentation: 7000-7999
#  - Websites: 9000-9999
#
# Please run `make install` to get the dependencies install

version: "3.7"
services:
  appeals-service-api:
    image: node:14-alpine
    environment:
      LPA_DATA_PATH: /opt/app/data/lpa-list.csv
      LPA_TRIALIST_DATA_PATH: /opt/app/data/lpa-trialists.json
      MONGODB_URL: mongodb://mongodb:27017/appeals-service-api
      SERVER_SHOW_ERRORS: "true"
    ports:
      - 3000:3000
    working_dir: /opt/app
    links:
      - mock-notify
      - mongodb
    depends_on:
      - appeals-service-api-data
      - mock-notify
      - mongodb
    volumes:
      - ./common:/opt/app/node_modules/@pins/common # Replace the module to avoid symlink errors
      - ./appeals-service-api:/opt/app
    command: npm run start:dev

  forms-web-app:
    image: node:14-alpine
    environment:
      APPEALS_SERVICE_API_URL: http://appeals-service-api:3000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SESSION_KEY: some_secure_key_goes_here
      USE_SECURE_SESSION_COOKIES: "false"
    ports:
      - 9000:3000
    working_dir: /opt/app
    links:
      - appeals-service-api
      - redis
    depends_on:
      - appeals-service-api
      - redis
    volumes:
      - ./forms-web-app:/opt/app
    command: npm run start:dev

  # Populate the database with data - one instance per service
  appeals-service-api-data:
    build:
      context: ./data
    links:
      - mongodb
    depends_on:
      - mongodb
    volumes:
      - ./data:/opt/app
    environment:
      SOURCE_DIR: appeals-service-api
      MONGODB_URL: mongodb://mongodb:27017/appeals-service-api
    restart: on-failure
    command: npm start

  # Mocked services
  mock-horizon:
    # @todo generate from Swagger Docs
    build:
      context: ./mocked-services/horizon
      dockerfile: ../Dockerfile
    ports:
      - 5000:3000

  mock-notify:
    build:
      context: ./mocked-services/notify
      dockerfile: ../Dockerfile
    ports:
      - 5001:3000

  docs-horizon:
    image: swaggerapi/swagger-ui
    environment:
      SWAGGER_JSON: /app/swagger.yaml
    depends_on:
      - mock-horizon
    volumes:
      - ./docs/swagger/horizon/create_case_openapi.yaml:/app/swagger.yaml
    ports:
      - 7000:8080

  # Third-party services
  mongodb:
    image: mongo:3.6.0
    ports:
      - 4000:27017

  redis:
    image: redis:4.0.14-alpine
    ports:
      - 4001:6379
