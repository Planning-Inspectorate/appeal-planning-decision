name: Cypress

on:
  push:
    branches: [master]
  pull_request:
    branches: [ master ]

jobs:

  cypress:
    name: "Cypress"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: launch the world
      run: make install && docker-compose up -d

    - name: run the tests
      run: cd ./e2e-tests && npm install && npm run test:e2e

    - name: Save Cypress videos
      if: ${{ failure() }}
      uses: actions/upload-artifact@main
      with:
        name: videos
        path: './e2e-tests/cypress/videos'

    - name: Save Cypress screenshots
      if: ${{ failure() }}
      uses: actions/upload-artifact@main
      with:
        name: screenshots
        path: './e2e-tests/cypress/screenshots'

    - name: post-process Cypress results
      if: ${{ always() }}
      run: cd ./e2e-tests && node ./reporter.js

    - name: publish Cypress results
      if: ${{ always() }}
      uses: deblockt/cucumber-report-annotations-action@v1.7
      with:
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: "e2e-tests/cypress/cucumber-json/*cucumber.json"
